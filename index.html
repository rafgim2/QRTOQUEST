<script>
const video = document.getElementById("video");
const msg = document.getElementById("msg");
const resultEl = document.getElementById("result");
const openBtn = document.getElementById("openBtn");
let lastURL = null;

async function startCamera() {
  msg.textContent = "Activando cámara trasera...";

  try {
    // Intento 1: cámara trasera estándar
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    });

    startDecoding(stream);
  } catch (e1) {
    console.warn("Fallo environment:", e1);

    try {
      // Intento 2: cualquier cámara disponible
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
      });

      startDecoding(stream);
    } catch (e2) {
      console.error("Cámara no disponible:", e2);
      msg.innerHTML = "❌ No se pudo acceder a la cámara.<br>Revisa permisos en Chrome → Configuración → Cámara";
    }
  }
}

function startDecoding(stream) {
  video.srcObject = stream;
  video.style.display = "block";
  msg.textContent = "";

  video.onloadedmetadata = () => video.play();

  // ZXing lee desde el <video>
  const reader = new ZXing.BrowserMultiFormatReader();

  reader.decodeFromVideoElement(video, (result, err) => {
    if (result) handleQR(result.text);
  });
}

function handleQR(url) {
  lastURL = url;
  resultEl.innerHTML = `Código leído:<br><b>${url}</b>`;
  openBtn.style.display = "inline-block";

  // deep-link a Meta Horizon / Meta Quest
  window.location.href = "metaquest://open/?url=" + encodeURIComponent(url);
}

document.getElementById("startBtn").onclick = () => {
  startCamera();
};
</script>
